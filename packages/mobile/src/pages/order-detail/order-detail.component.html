<div class="order-detail-container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <div class="loading-container" *ngIf="loading">
    <div class="loading-spinner"></div>
    <p>åŠ è½½ä¸­...</p>
  </div>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <div class="error-container" *ngIf="error && !loading">
    <div class="error-icon">âš ï¸</div>
    <p class="error-message">{{ error }}</p>
    <button class="btn btn-primary" (click)="refreshOrder()">é‡è¯•</button>
  </div>

  <!-- è®¢å•è¯¦æƒ… -->
  <div class="order-content" *ngIf="order && !loading">
    <!-- å¤´éƒ¨ -->
    <div class="order-header">
      <button class="back-btn" (click)="goBack()">â† è¿”å›</button>
      <h1 class="order-title">è®¢å•è¯¦æƒ…</h1>
      <button class="refresh-btn" (click)="refreshOrder()">ğŸ”„</button>
    </div>

    <!-- è®¢å•åŸºæœ¬ä¿¡æ¯ -->
    <div class="order-info">
      <div class="order-id">
        <span class="label">è®¢å•å·:</span>
        <span class="value">{{ order.id }}</span>
      </div>
      <div class="order-status">
        <span class="status-badge" [style.background-color]="getStatusColor(order.status)">
          {{ getStatusIcon(order.status) }} {{ getStatusLabel(order.status) }}
        </span>
      </div>
      <div class="order-time">
        <span class="label">åˆ›å»ºæ—¶é—´:</span>
        <span class="value">{{ order.createdAt | date:'yyyy-MM-dd HH:mm:ss' }}</span>
      </div>
      <div class="order-total">
        <span class="label">è®¢å•é‡‘é¢:</span>
        <span class="value amount">Â¥{{ order.totalAmount / 100 }}</span>
      </div>
    </div>

    <!-- è®¢å•è¿›åº¦ -->
    <div class="order-progress" *ngIf="orderProgress">
      <h3>è®¢å•è¿›åº¦</h3>
      <div class="progress-steps">
        <div 
          class="step" 
          *ngFor="let step of orderProgress.steps; let i = index"
          [class.completed]="step.completed"
          [class.active]="step.active"
        >
          <div class="step-icon">
            <span *ngIf="step.completed">âœ“</span>
            <span *ngIf="!step.completed && !step.active">{{ i + 1 }}</span>
            <span *ngIf="step.active">â³</span>
          </div>
          <div class="step-content">
            <div class="step-label">{{ step.label }}</div>
            <div class="step-description">{{ step.description }}</div>
            <div class="step-time" *ngIf="step.timestamp">
              {{ formatTime(step.timestamp) }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- è®¢å•å•†å“ -->
    <div class="order-items" *ngIf="order.items && order.items.length > 0">
      <h3>è®¢å•å•†å“</h3>
      <div class="item-list">
        <div class="item" *ngFor="let item of order.items">
          <div class="item-info">
            <div class="item-name">{{ item.name }}</div>
            <div class="item-specs" *ngIf="item.specs">{{ item.specs }}</div>
            <div class="item-price">Â¥{{ item.price / 100 }}</div>
          </div>
          <div class="item-quantity">x{{ item.quantity }}</div>
        </div>
      </div>
    </div>

    <!-- æ ¸é”€äºŒç»´ç  -->
    <div class="verification-section" *ngIf="shouldShowQRCode()">
      <h3>æ ¸é”€ç </h3>
      <div class="qr-code-container">
        <div class="qr-code-display" *ngIf="showQRCode && qrCodeImage">
          <img [src]="qrCodeImage" alt="æ ¸é”€äºŒç»´ç " class="qr-code-image">
          <div class="qr-code-info">
            <p class="qr-code-text">è¯·å‘å•†å®¶å‡ºç¤ºæ­¤äºŒç»´ç </p>
            <p class="qr-code-time" *ngIf="!isQRCodeExpired()">
              å‰©ä½™æ—¶é—´: {{ getQRCodeRemainingTime() }}
            </p>
            <p class="qr-code-expired" *ngIf="isQRCodeExpired()">
              äºŒç»´ç å·²è¿‡æœŸï¼Œè¯·åˆ·æ–°è·å–æ–°çš„æ ¸é”€ç 
            </p>
          </div>
        </div>
        
        <div class="qr-code-actions">
          <button 
            class="btn btn-primary" 
            (click)="toggleQRCode()"
            [disabled]="isQRCodeExpired()"
          >
            {{ showQRCode ? 'éšè—äºŒç»´ç ' : 'æ˜¾ç¤ºäºŒç»´ç ' }}
          </button>
          
          <button 
            class="btn btn-secondary" 
            (click)="saveQRCodeToAlbum()"
            *ngIf="showQRCode && qrCodeImage"
          >
            ä¿å­˜åˆ°ç›¸å†Œ
          </button>
          
          <button 
            class="btn btn-secondary" 
            (click)="shareOrder()"
            *ngIf="verificationInfo"
          >
            åˆ†äº«è®¢å•
          </button>
        </div>
      </div>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="order-actions">
      <button 
        class="btn btn-danger" 
        (click)="cancelOrder()"
        *ngIf="canCancel"
        [disabled]="!cancelReason.trim()"
      >
        å–æ¶ˆè®¢å•
      </button>
      
      <button 
        class="btn btn-warning" 
        (click)="requestRefund()"
        *ngIf="canRefund"
        [disabled]="!refundReason.trim()"
      >
        ç”³è¯·é€€æ¬¾
      </button>
    </div>

    <!-- å–æ¶ˆ/é€€æ¬¾åŸå› è¾“å…¥ -->
    <div class="reason-input" *ngIf="canCancel || canRefund">
      <div class="input-group" *ngIf="canCancel">
        <label>å–æ¶ˆåŸå› :</label>
        <textarea 
          [(ngModel)]="cancelReason" 
          placeholder="è¯·è¾“å…¥å–æ¶ˆåŸå› "
          rows="3"
        ></textarea>
      </div>
      
      <div class="input-group" *ngIf="canRefund">
        <label>é€€æ¬¾åŸå› :</label>
        <textarea 
          [(ngModel)]="refundReason" 
          placeholder="è¯·è¾“å…¥é€€æ¬¾åŸå› "
          rows="3"
        ></textarea>
      </div>
    </div>
  </div>
</div>
